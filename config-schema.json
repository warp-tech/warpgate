{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "WarpgateConfigStore",
  "type": "object",
  "properties": {
    "database_url": {
      "type": "string",
      "default": "sqlite:data/db"
    },
    "external_host": {
      "type": [
        "string",
        "null"
      ],
      "default": null
    },
    "http": {
      "$ref": "#/$defs/HttpConfig",
      "default": {
        "certificate": "",
        "cookie_max_age": "1day",
        "external_port": null,
        "key": "",
        "listen": "[::]:8888",
        "session_max_age": "30m",
        "sni_certificates": [],
        "trust_x_forwarded_headers": false
      }
    },
    "log": {
      "$ref": "#/$defs/LogConfig",
      "default": {
        "retention": "7days",
        "send_to": null
      }
    },
    "login_protection": {
      "$ref": "#/$defs/LoginProtectionConfig",
      "default": {
        "enabled": true,
        "ip_rate_limit": {
          "base_block_duration_minutes": 30,
          "block_duration_multiplier": 2.0,
          "blocked_message": null,
          "cooldown_reset_hours": 24,
          "max_attempts": 5,
          "max_block_duration_hours": 24,
          "time_window_minutes": 15
        },
        "retention_days": 30,
        "user_lockout": {
          "auto_unlock": false,
          "locked_message": null,
          "lockout_duration_minutes": 60,
          "max_attempts": 10,
          "time_window_minutes": 60
        }
      }
    },
    "mysql": {
      "$ref": "#/$defs/MySqlConfig",
      "default": {
        "certificate": "",
        "enable": false,
        "external_port": null,
        "key": "",
        "listen": "[::]:33306"
      }
    },
    "postgres": {
      "$ref": "#/$defs/PostgresConfig",
      "default": {
        "certificate": "",
        "enable": false,
        "external_port": null,
        "key": "",
        "listen": "[::]:55432"
      }
    },
    "recordings": {
      "$ref": "#/$defs/RecordingsConfig",
      "default": {
        "enable": false,
        "path": "./data/recordings"
      }
    },
    "ssh": {
      "$ref": "#/$defs/SshConfig",
      "default": {
        "enable": false,
        "external_port": null,
        "host_key_verification": "prompt",
        "inactivity_timeout": "5m",
        "keepalive_interval": null,
        "keys": "./data/keys",
        "listen": "[::]:2222"
      }
    },
    "sso_providers": {
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/SsoProviderConfig"
      }
    }
  },
  "$defs": {
    "Duration": {
      "type": "object",
      "properties": {
        "nanos": {
          "type": "integer",
          "format": "uint32",
          "minimum": 0
        },
        "secs": {
          "type": "integer",
          "format": "uint64",
          "minimum": 0
        }
      },
      "required": [
        "secs",
        "nanos"
      ]
    },
    "HttpConfig": {
      "type": "object",
      "properties": {
        "certificate": {
          "type": "string",
          "default": ""
        },
        "cookie_max_age": {
          "type": "string",
          "default": "1day"
        },
        "external_port": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "default": null,
          "maximum": 65535,
          "minimum": 0
        },
        "key": {
          "type": "string",
          "default": ""
        },
        "listen": {
          "$ref": "#/$defs/ListenEndpoint",
          "default": "[::]:8888"
        },
        "session_max_age": {
          "type": "string",
          "default": "30m"
        },
        "sni_certificates": {
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/$defs/SniCertificateConfig"
          }
        },
        "trust_x_forwarded_headers": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "IpRateLimitConfig": {
      "description": "Configuration for IP-based rate limiting",
      "type": "object",
      "properties": {
        "base_block_duration_minutes": {
          "description": "Base block duration in minutes (first block)",
          "type": "integer",
          "format": "uint32",
          "default": 30,
          "minimum": 0
        },
        "block_duration_multiplier": {
          "description": "Multiplier for exponential backoff (e.g., 2.0 means each block doubles)",
          "type": "number",
          "format": "float",
          "default": 2.0
        },
        "blocked_message": {
          "description": "Custom message to display to blocked users",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "cooldown_reset_hours": {
          "description": "Hours without failed attempts before block count resets to zero",
          "type": "integer",
          "format": "uint32",
          "default": 24,
          "minimum": 0
        },
        "max_attempts": {
          "description": "Maximum failed attempts per IP before blocking",
          "type": "integer",
          "format": "uint32",
          "default": 5,
          "minimum": 0
        },
        "max_block_duration_hours": {
          "description": "Maximum block duration in hours (cap for exponential backoff)",
          "type": "integer",
          "format": "uint32",
          "default": 24,
          "minimum": 0
        },
        "time_window_minutes": {
          "description": "Time window in minutes for counting failed attempts",
          "type": "integer",
          "format": "uint32",
          "default": 15,
          "minimum": 0
        }
      }
    },
    "ListenEndpoint": {
      "type": "string"
    },
    "LogConfig": {
      "type": "object",
      "properties": {
        "retention": {
          "type": "string",
          "default": "7days"
        },
        "send_to": {
          "type": [
            "string",
            "null"
          ],
          "default": null
        }
      }
    },
    "LoginProtectionConfig": {
      "description": "Configuration for login protection (brute-force protection)",
      "type": "object",
      "properties": {
        "enabled": {
          "description": "Whether login protection is enabled",
          "type": "boolean",
          "default": true
        },
        "ip_rate_limit": {
          "description": "IP-based rate limiting configuration",
          "$ref": "#/$defs/IpRateLimitConfig",
          "default": {
            "base_block_duration_minutes": 30,
            "block_duration_multiplier": 2.0,
            "blocked_message": null,
            "cooldown_reset_hours": 24,
            "max_attempts": 5,
            "max_block_duration_hours": 24,
            "time_window_minutes": 15
          }
        },
        "retention_days": {
          "description": "Days to retain failed login attempt records",
          "type": "integer",
          "format": "uint32",
          "default": 30,
          "minimum": 0
        },
        "user_lockout": {
          "description": "User account lockout configuration",
          "$ref": "#/$defs/UserLockoutConfig",
          "default": {
            "auto_unlock": false,
            "locked_message": null,
            "lockout_duration_minutes": 60,
            "max_attempts": 10,
            "time_window_minutes": 60
          }
        }
      }
    },
    "MySqlConfig": {
      "type": "object",
      "properties": {
        "certificate": {
          "type": "string",
          "default": ""
        },
        "enable": {
          "type": "boolean",
          "default": false
        },
        "external_port": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "default": null,
          "maximum": 65535,
          "minimum": 0
        },
        "key": {
          "type": "string",
          "default": ""
        },
        "listen": {
          "$ref": "#/$defs/ListenEndpoint",
          "default": "[::]:33306"
        }
      }
    },
    "PostgresConfig": {
      "type": "object",
      "properties": {
        "certificate": {
          "type": "string",
          "default": ""
        },
        "enable": {
          "type": "boolean",
          "default": false
        },
        "external_port": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "default": null,
          "maximum": 65535,
          "minimum": 0
        },
        "key": {
          "type": "string",
          "default": ""
        },
        "listen": {
          "$ref": "#/$defs/ListenEndpoint",
          "default": "[::]:55432"
        }
      }
    },
    "RecordingsConfig": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "boolean",
          "default": false
        },
        "path": {
          "type": "string",
          "default": "./data/recordings"
        }
      }
    },
    "SniCertificateConfig": {
      "type": "object",
      "properties": {
        "certificate": {
          "type": "string"
        },
        "key": {
          "type": "string"
        }
      },
      "required": [
        "certificate",
        "key"
      ]
    },
    "SshConfig": {
      "type": "object",
      "properties": {
        "enable": {
          "type": "boolean",
          "default": false
        },
        "external_port": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint16",
          "default": null,
          "maximum": 65535,
          "minimum": 0
        },
        "host_key_verification": {
          "$ref": "#/$defs/SshHostKeyVerificationMode",
          "default": "prompt"
        },
        "inactivity_timeout": {
          "type": "string",
          "default": "5m"
        },
        "keepalive_interval": {
          "anyOf": [
            {
              "$ref": "#/$defs/Duration"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "keys": {
          "type": "string",
          "default": "./data/keys"
        },
        "listen": {
          "$ref": "#/$defs/ListenEndpoint",
          "default": "[::]:2222"
        }
      }
    },
    "SshHostKeyVerificationMode": {
      "type": "string",
      "enum": [
        "prompt",
        "auto_accept",
        "auto_reject"
      ]
    },
    "SsoInternalProviderConfig": {
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "google"
            },
            "client_id": {
              "type": "string"
            },
            "client_secret": {
              "type": "string"
            }
          },
          "required": [
            "type",
            "client_id",
            "client_secret"
          ]
        },
        {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "apple"
            },
            "client_id": {
              "type": "string"
            },
            "client_secret": {
              "type": "string"
            },
            "key_id": {
              "type": "string"
            },
            "team_id": {
              "type": "string"
            }
          },
          "required": [
            "type",
            "client_id",
            "client_secret",
            "key_id",
            "team_id"
          ]
        },
        {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "azure"
            },
            "client_id": {
              "type": "string"
            },
            "client_secret": {
              "type": "string"
            },
            "tenant": {
              "type": "string"
            }
          },
          "required": [
            "type",
            "client_id",
            "client_secret",
            "tenant"
          ]
        },
        {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "custom"
            },
            "additional_trusted_audiences": {
              "type": [
                "array",
                "null"
              ],
              "items": {
                "type": "string"
              }
            },
            "client_id": {
              "type": "string"
            },
            "client_secret": {
              "type": "string"
            },
            "issuer_url": {
              "type": "string"
            },
            "role_mappings": {
              "type": [
                "object",
                "null"
              ],
              "additionalProperties": {
                "type": "string"
              }
            },
            "scopes": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "trust_unknown_audiences": {
              "type": "boolean",
              "default": false
            }
          },
          "required": [
            "type",
            "client_id",
            "client_secret",
            "issuer_url",
            "scopes"
          ]
        }
      ]
    },
    "SsoProviderConfig": {
      "type": "object",
      "properties": {
        "auto_create_users": {
          "type": "boolean",
          "default": false
        },
        "label": {
          "type": [
            "string",
            "null"
          ]
        },
        "name": {
          "type": "string"
        },
        "provider": {
          "$ref": "#/$defs/SsoInternalProviderConfig"
        },
        "return_domain_whitelist": {
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "name",
        "provider"
      ]
    },
    "UserLockoutConfig": {
      "description": "Configuration for user account lockout",
      "type": "object",
      "properties": {
        "auto_unlock": {
          "description": "Whether to automatically unlock after lockout duration",
          "type": "boolean",
          "default": false
        },
        "locked_message": {
          "description": "Custom message to display to locked users",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "lockout_duration_minutes": {
          "description": "Lockout duration in minutes (if auto_unlock is enabled)",
          "type": "integer",
          "format": "uint32",
          "default": 60,
          "minimum": 0
        },
        "max_attempts": {
          "description": "Maximum failed attempts per user before lockout",
          "type": "integer",
          "format": "uint32",
          "default": 10,
          "minimum": 0
        },
        "time_window_minutes": {
          "description": "Time window in minutes for counting failed attempts",
          "type": "integer",
          "format": "uint32",
          "default": 60,
          "minimum": 0
        }
      }
    }
  }
}
